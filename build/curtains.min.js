/***
    Little WebGL helper to apply images as textures of planes
    Author: Martin Laxenaire https://www.martin-laxenaire.fr/
    Version: 1.0
***/

function Curtains(t){this.planes=[];var e=t||"canvas";return this.container=document.getElementById(e),this.container?(this.loadingManager={texturesLoaded:0},this._init(),this):(console.warn("You must specify a valid container ID"),!1)}function Plane(t,e,i){this.wrapper=t,this.htmlElement=e,this.images=[],this.textures=[],this.index=this.wrapper.planes.length,this.canDraw=!1,this.definition={width:parseInt(i.widthSegments)||1,height:parseInt(i.heightSegments)||1},this.mimicCSS=i.mimicCSS,null!==this.mimicCSS&&void 0!==this.mimicCSS||(this.mimicCSS=!0),this.imageCover=i.imageCover,null!==this.imageCover&&void 0!==this.imageCover||(this.imageCover=!0),this.crossOrigin=i.crossOrigin,this.fov=i.fov||75;var r=i.vertexShaderID||e.getAttribute("data-vs-id"),s=i.fragmentShaderID||e.getAttribute("data-fs-id");if(!r||!s)return console.warn("No vertex or fragment shaders ID provided"),!1;if(this.program=this.wrapper.glContext.createProgram(),this.shaders={},this.shaders.vertexShaderCode=document.getElementById(r).innerHTML,this.shaders.fragmentShaderCode=document.getElementById(s).innerHTML,this.shaders.vertexShader=this.wrapper._createShader(this.shaders.vertexShaderCode,this.wrapper.glContext.VERTEX_SHADER),this.shaders.fragmentShader=this.wrapper._createShader(this.shaders.fragmentShaderCode,this.wrapper.glContext.FRAGMENT_SHADER),!this.shaders.vertexShader||!this.shaders.fragmentShader)return console.warn("Unable to find the vertex or fragment shader"),this.wrapper.container.classList.add("no-webgl-curtains"),!1;if(this.wrapper.glContext.attachShader(this.program,this.shaders.vertexShader),this.wrapper.glContext.attachShader(this.program,this.shaders.fragmentShader),this.wrapper.glContext.linkProgram(this.program),!this.wrapper.glContext.getProgramParameter(this.program,this.wrapper.glContext.LINK_STATUS))return console.warn("Unable to initialize the shader program."),this.wrapper.container.classList.add("no-webgl-curtains"),!1;this.wrapper.glContext.useProgram(this.program),this.matrix={},this.matrix.mvMatrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.matrix.pMatrix=this._setPerspectiveMatrix(this.fov,.1,2*this.fov),this.scale={x:1,y:1},this.matrix.pMatrixUniform=this.wrapper.glContext.getUniformLocation(this.program,"uPMatrix"),this.matrix.mvMatrixUniform=this.wrapper.glContext.getUniformLocation(this.program,"uMVMatrix");return this._setAttributes({vertexPosition:"aVertexPosition",textureCoord:"aTextureCoord"}),this}Curtains.prototype._init=function(){this.glCanvas=document.createElement("canvas"),this.glContext&&(this.glContext.getExtension("WEBGL_lose_context").loseContext(),this.glContext=null),this.glContext=this.glCanvas.getContext("webgl",{alpha:!0})||this.glCanvas.getContext("experimental-webgl"),this.glCanvas.width=this.container.clientWidth,this.glCanvas.height=this.container.clientHeight,this.glContext.viewport(0,0,this.glCanvas.width,this.glCanvas.height),this._readyToDraw()},Curtains.prototype._isInitialized=function(){if(!this.glCanvas||!this.glContext)return console.warn("No WebGL canvas or context"),!1},Curtains.prototype.dispose=function(){window.cancelAnimationFrame(this.requestAnimationFrameID),this.glContext&&(this.glContext.getExtension("WEBGL_lose_context").loseContext(),this.glContext=null)},Curtains.prototype._createPlane=function(t,e){var i=new Plane(this,t,e);return this.planes.push(i),i},Curtains.prototype.addPlane=function(t,e){if(!t||0===t.length)return console.warn("The html element you specified does not currently exists in the DOM"),!1;for(var i=this._createPlane(t,e),r=[],s=0;s<i.htmlElement.getElementsByTagName("img").length;s++)r.push(i.htmlElement.getElementsByTagName("img")[s]);return r.length>0?i.loadImages(r):console.warn("This plane does not contain any image element. You may want to add some later with the loadImages method."),e.uniforms||(e.uniforms={},console.warn("You are setting a plane without uniforms, you won't be able to interact with it. Please check your addPlane method for : ",i.htmlElement)),i._setUniforms(e.uniforms),i},Curtains.prototype._createShader=function(t,e){this._isInitialized();var i=this.glContext.createShader(e);return this.glContext.shaderSource(i,t),this.glContext.compileShader(i),this.glContext.getShaderParameter(i,this.glContext.COMPILE_STATUS)?i:(console.log("Errors occurred while compiling the shader:\n"+this.glContext.getShaderInfoLog(i)),this.container.classList.add("no-webgl-curtains"),null)},Curtains.prototype._reSize=function(){if(this.glCanvas.width!==Math.floor(this.container.clientWidth)||this.glCanvas.height!==Math.floor(this.container.clientHeight)){this.glCanvas.width=Math.floor(this.container.clientWidth),this.glCanvas.height=Math.floor(this.container.clientHeight),this.glContext.viewport(0,0,this.glCanvas.width,this.glCanvas.height);for(var t=0;t<this.planes.length;t++)this.planes[t].canDraw&&this.planes[t]._planeResize()}},Curtains.prototype._readyToDraw=function(){this._isInitialized(),this.container.appendChild(this.glCanvas),this.glContext.enable(this.glContext.DEPTH_TEST),this.glContext.blendFunc(this.glContext.SRC_ALPHA,this.glContext.ONE_MINUS_SRC_ALPHA),this.glContext.enable(this.glContext.BLEND),console.log("Curtains.js - v1.0");var t=this;!function e(){t._drawScene(),t.requestAnimationFrameID=window.requestAnimationFrame(e)}()},Curtains.prototype._drawScene=function(){this._isInitialized(),this.glContext.clearColor(0,0,0,0),this.glContext.clearDepth(1),this._reSize();for(var t=0;t<this.planes.length;t++){var e=this.planes[t];if(this.glContext.isProgram(e.program)&&e.canDraw){this.glContext.useProgram(e.program),e.onRenderCallback&&e.onRenderCallback();for(var i=0;i<e.textures.length;i++)this.glContext.activeTexture(this.glContext.TEXTURE0+e.textures[i].index),this.glContext.bindTexture(this.glContext.TEXTURE_2D,e.textures[i]);e._updateUniforms(),e._bindPlaneBuffers(),this.glContext.uniformMatrix4fv(e.matrix.pMatrixUniform,!1,e.matrix.pMatrix),this.glContext.uniformMatrix4fv(e.matrix.mvMatrixUniform,!1,e.matrix.mvMatrix),this.glContext.drawArrays(this.glContext.TRIANGLES,0,e.geometry.verticesBuffer.numberOfItems)}}},Plane.prototype._isProgramInitialized=function(){if(!this.program)return console.warn("No WebGL program for this plane"),!1},Plane.prototype.onLoading=function(t){return t&&(this.onPlaneLoadingCallback=t),this},Plane.prototype.planeTexturesLoaded=function(t){return t&&(this._texturesLoadedCallback=t),this},Plane.prototype.onReady=function(t){return t&&(this._onReadyCallback=t),this},Plane.prototype.onRender=function(t){return t&&(this.onRenderCallback=t),this},Plane.prototype._setPlaneDefinition=function(t,e){this.wrapper.glContext.useProgram(this.program);for(var i=0;i<this.textures.length;i++)if(this.images[i].sampler){var r=this.images[i].sampler;this.uniforms[r]={},this.uniforms[r].location=this.wrapper.glContext.getUniformLocation(this.program,r),this.uniforms[r].coreUniform=!0,this.wrapper.glContext.uniform1i(this.uniforms[r].location,this.textures[i].index)}else this.uniforms["sampler"+this.textures[i].index]={},this.uniforms["sampler"+this.textures[i].index].location=this.wrapper.glContext.getUniformLocation(this.program,"uSampler"+i),this.uniforms["sampler"+this.textures[i].index].coreUniform=!0,this.wrapper.glContext.uniform1i(this.uniforms["sampler"+this.textures[i].index].location,this.textures[i].index);this._initializeBuffers(t,e)},Plane.prototype._setPlaneVertices=function(t,e){for(var i={vertices:[],uvs:[]},r=0;r<e;++r)for(var s=r/e,a=0;a<t;++a){var n=a/t;i.uvs.push(n),i.uvs.push(s),i.uvs.push(0),i.vertices.push(2*(n-.5)),i.vertices.push(2*(s-.5)),i.vertices.push(0),i.uvs.push(n+1/t),i.uvs.push(s),i.uvs.push(0),i.vertices.push(2*(n+1/t-.5)),i.vertices.push(2*(s-.5)),i.vertices.push(0),i.uvs.push(n),i.uvs.push(s+1/e),i.uvs.push(0),i.vertices.push(2*(n-.5)),i.vertices.push(2*(s+1/e-.5)),i.vertices.push(0),i.uvs.push(n),i.uvs.push(s+1/e),i.uvs.push(0),i.vertices.push(2*(n-.5)),i.vertices.push(2*(s+1/e-.5)),i.vertices.push(0),i.uvs.push(n+1/t),i.uvs.push(s+1/e),i.uvs.push(0),i.vertices.push(2*(n+1/t-.5)),i.vertices.push(2*(s+1/e-.5)),i.vertices.push(0),i.uvs.push(n+1/t),i.uvs.push(s),i.uvs.push(0),i.vertices.push(2*(n+1/t-.5)),i.vertices.push(2*(s-.5)),i.vertices.push(0)}return i},Plane.prototype._initializeBuffers=function(t,e){this.wrapper._isInitialized(),this._isProgramInitialized(),t=Math.floor(t)||1,e=Math.floor(e)||1,planeWidth=this.htmlElement.clientWidth||this.wrapper.glCanvas.width,planeHeight=this.htmlElement.clientHeight||this.wrapper.glCanvas.height,this.size={width:planeWidth,height:planeHeight},this.geometry={},this.geometry.innerScale={x:planeWidth/this.wrapper.glCanvas.width,y:planeHeight/this.wrapper.glCanvas.height},this.clipSpace={x:(this.geometry.innerScale.x-1)*(this.wrapper.glCanvas.width/this.wrapper.glCanvas.height/2)/this.scale.x,y:(1-this.geometry.innerScale.y)/2/this.scale.y,width:this.wrapper.glCanvas.width/this.wrapper.glCanvas.height,height:2},this.rotation={x:0,y:0,z:0},this.relativeTranslation={x:0,y:0},this.mimicCSS?this._applyCSSPositions():this.setTranslation(0,0,0);for(var i=0;i<this.textures.length;i++)this._adjustTextureSize(i);var r=this._setPlaneVertices(t,e);this.geometry.vertices=r.vertices,this.geometry.verticesBuffer=this.wrapper.glContext.createBuffer(),this.wrapper.glContext.bindBuffer(this.wrapper.glContext.ARRAY_BUFFER,this.geometry.verticesBuffer),this.wrapper.glContext.bufferData(this.wrapper.glContext.ARRAY_BUFFER,new Float32Array(this.geometry.vertices),this.wrapper.glContext.STATIC_DRAW),this.geometry.verticesBuffer.itemSize=3,this.geometry.verticesBuffer.numberOfItems=this.geometry.vertices.length/this.geometry.verticesBuffer.itemSize,this.material={},this.material.uvs=r.uvs,this.material.texCoordBuffer=this.wrapper.glContext.createBuffer(),this.wrapper.glContext.bindBuffer(this.wrapper.glContext.ARRAY_BUFFER,this.material.texCoordBuffer),this.wrapper.glContext.bufferData(this.wrapper.glContext.ARRAY_BUFFER,new Float32Array(this.material.uvs),this.wrapper.glContext.STATIC_DRAW),this.material.texCoordBuffer.itemSize=3,this.material.texCoordBuffer.numberOfItems=this.material.uvs.length/this.material.texCoordBuffer.itemSize,this.canDraw=!0,this._onReadyCallback&&this._onReadyCallback()},Plane.prototype._bindPlaneBuffers=function(){this.wrapper._isInitialized(),this._isProgramInitialized(),this.wrapper.glContext.bindBuffer(this.wrapper.glContext.ARRAY_BUFFER,this.geometry.verticesBuffer),this.wrapper.glContext.vertexAttribPointer(this.attributes.vertexPosition,this.geometry.verticesBuffer.itemSize,this.wrapper.glContext.FLOAT,!1,0,0),this.wrapper.glContext.enableVertexAttribArray(this.attributes.vertexPosition),this.wrapper.glContext.bindBuffer(this.wrapper.glContext.ARRAY_BUFFER,this.material.texCoordBuffer),this.wrapper.glContext.vertexAttribPointer(this.attributes.textureCoord,this.material.texCoordBuffer.itemSize,this.wrapper.glContext.FLOAT,!1,0,0),this.wrapper.glContext.enableVertexAttribArray(this.attributes.textureCoord)},Plane.prototype._setAttributes=function(t){this.wrapper._isInitialized(),this._isProgramInitialized(),this.attributes||(this.attributes={});var e=this;Object.keys(t).map(function(i,r){var s=t[i];e.attributes[i]=e.wrapper.glContext.getAttribLocation(e.program,s)})},Plane.prototype._handleUniformSetting=function(t,e,i){"1i"==t?this.wrapper.glContext.uniform1i(e,i):"1iv"==t?this.wrapper.glContext.uniform1iv(e,i):"1f"==t?this.wrapper.glContext.uniform1f(e,i):"1fv"==t?this.wrapper.glContext.uniform1fv(e,i):"2i"==t?this.wrapper.glContext.uniform2i(e,i[0],i[1]):"2iv"==t?this.wrapper.glContext.uniform2iv(e,i):"2f"==t?this.wrapper.glContext.uniform2f(e,i[0],i[1]):"2fv"==t?this.wrapper.glContext.uniform2fv(e,i):"3i"==t?this.wrapper.glContext.uniform3i(e,i[0],i[1],i[2]):"3iv"==t?this.wrapper.glContext.uniform3iv(e,i):"3f"==t?this.wrapper.glContext.uniform3f(e,i[0],i[1],i[2]):"3fv"==t?this.wrapper.glContext.uniform3fv(e,i):"4i"==t?this.wrapper.glContext.uniform4i(e,i[0],i[1],i[2],i[3]):"4iv"==t?this.wrapper.glContext.uniform4iv(e,i):"4f"==t?this.wrapper.glContext.uniform4f(e,i[0],i[1],i[2],i[3]):"4fv"==t?this.wrapper.glContext.uniform4fv(e,i):console.log("This uniform type is not handled : ",t)},Plane.prototype._setUniforms=function(t){this.wrapper._isInitialized(),this._isProgramInitialized(),this.wrapper.glContext.useProgram(this.program),this.uniforms||(this.uniforms={});var e=this;t&&Object.keys(t).map(function(i,r){var s=t[i];e.uniforms[i]={location:e.wrapper.glContext.getUniformLocation(e.program,s.name),name:s.name,type:s.type,value:s.value,coreUniform:!1},e._handleUniformSetting(s.type,e.uniforms[i].location,s.value)})},Plane.prototype._updateUniforms=function(){if(this.wrapper._isInitialized(),this._isProgramInitialized(),this.wrapper.glContext.useProgram(this.program),this.uniforms&&this.wrapper.glContext.isProgram(this.program)){var t=this.uniforms,e=this;Object.keys(t).map(function(i,r){var s=t[i];if(!s.coreUniform){var a=s.location,n=s.value,o=s.type;e._handleUniformSetting(o,a,n)}})}},Plane.prototype._addMatrix=function(t,e){var i=[];return i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i[4]=t[4]+e[4],i[5]=t[5]+e[5],i[6]=t[6]+e[6],i[7]=t[7]+e[7],i[8]=t[8]+e[8],i[9]=t[9]+e[9],i[10]=t[10]+e[10],i[11]=t[11]+e[11],i[12]=t[12]+e[12],i[13]=t[13]+e[13],i[14]=t[14]+e[14],i[15]=t[15]+e[15],i},Plane.prototype._multiplyMatrix=function(t,e){var i=[],r=t[0],s=t[1],a=t[2],n=t[3],o=t[4],h=t[5],l=t[6],p=t[7],g=t[8],u=t[9],m=t[10],x=t[11],c=t[12],f=t[13],d=t[14],C=t[15],w=e[0],v=e[1],y=e[2],_=e[3];return i[0]=w*r+v*o+y*g+_*c,i[1]=w*s+v*h+y*u+_*f,i[2]=w*a+v*l+y*m+_*d,i[3]=w*n+v*p+y*x+_*C,w=e[4],v=e[5],y=e[6],_=e[7],i[4]=w*r+v*o+y*g+_*c,i[5]=w*s+v*h+y*u+_*f,i[6]=w*a+v*l+y*m+_*d,i[7]=w*n+v*p+y*x+_*C,w=e[8],v=e[9],y=e[10],_=e[11],i[8]=w*r+v*o+y*g+_*c,i[9]=w*s+v*h+y*u+_*f,i[10]=w*a+v*l+y*m+_*d,i[11]=w*n+v*p+y*x+_*C,w=e[12],v=e[13],y=e[14],_=e[15],i[12]=w*r+v*o+y*g+_*c,i[13]=w*s+v*h+y*u+_*f,i[14]=w*a+v*l+y*m+_*d,i[15]=w*n+v*p+y*x+_*C,i},Plane.prototype._invertMatrix=function(t){var e=[],i=t[0],r=t[1],s=t[2],a=t[3],n=t[4],o=t[5],h=t[6],l=t[7],p=t[8],g=t[9],u=t[10],m=t[11],x=t[12],c=t[13],f=t[14],d=t[15],C=i*o-r*n,w=i*h-s*n,v=i*l-a*n,y=r*h-s*o,_=r*l-a*o,P=s*l-a*h,S=p*c-g*x,T=p*f-u*x,E=p*d-m*x,R=g*f-u*c,M=g*d-m*c,A=u*d-m*f,I=C*A-w*M+v*R+y*E-_*T+P*S;return I?(I=1/I,e[0]=(o*A-h*M+l*R)*I,e[1]=(s*M-r*A-a*R)*I,e[2]=(c*P-f*_+d*y)*I,e[3]=(u*_-g*P-m*y)*I,e[4]=(h*E-n*A-l*T)*I,e[5]=(i*A-s*E+a*T)*I,e[6]=(f*v-x*P-d*w)*I,e[7]=(p*P-u*v+m*w)*I,e[8]=(n*M-o*E+l*S)*I,e[9]=(r*E-i*M-a*S)*I,e[10]=(x*_-c*v+d*C)*I,e[11]=(g*v-p*_-m*C)*I,e[12]=(o*T-n*R-h*S)*I,e[13]=(i*R-r*T+s*S)*I,e[14]=(c*w-x*y-f*C)*I,e[15]=(p*y-g*w+u*C)*I,e):null},Plane.prototype._setPerspectiveMatrix=function(t,e,i){var r=this.wrapper.glCanvas.width/this.wrapper.glCanvas.height;return t!==this.fov&&(this.fov=t),[t/r,0,0,0,0,t,0,0,0,0,(e+i)*(1/(e-i)),-1,0,0,e*i*(1/(e-i))*2,0]},Plane.prototype.setPerspective=function(t,e,i){var r=parseInt(t)||75;r<0?r=0:r>180&&(r=180);var s=parseFloat(e)||.1,a=parseFloat(i)||100,n=this.translation.x||0,o=this.translation.y||0;this.matrix.pMatrix=this._setPerspectiveMatrix(r,s,a),this.setTranslation(n,o,0)},Plane.prototype.setScale=function(t,e){this.wrapper._isInitialized(),this._isProgramInitialized(),t=parseFloat(t)||1,t=Math.max(t,.001),e=parseFloat(e)||1,e=Math.max(e,.001),this.scale={x:t,y:e},this.matrix.mvMatrix=this._setMVMatrix()},Plane.prototype.setRotation=function(t,e,i){this.wrapper._isInitialized(),this._isProgramInitialized(),t=parseFloat(t)||0,e=parseFloat(e)||0,i=parseFloat(i)||0,this.rotation={x:t,y:e,z:i},this.matrix.mvMatrix=this._setMVMatrix()},Plane.prototype.setTranslation=function(t,e,i){this.wrapper._isInitialized(),this._isProgramInitialized(),this.wrapper.glContext.useProgram(this.program),t=t||0,e=e||0,i=i||0,this.translation={x:t,y:e,z:i},this.matrix.mvMatrix=this._setMVMatrix()},Plane.prototype.setRelativePosition=function(t,e){var i=this._documentToPlaneSpace(t,e);this.relativeTranslation={x:t,y:e},this.setTranslation(i.x,i.y,plane.translation.z)},Plane.prototype._documentToPlaneSpace=function(t,e){return{x:this.clipSpace.x+t/this.wrapper.glCanvas.width*this.clipSpace.width,y:this.clipSpace.y-e/this.wrapper.glCanvas.height}},Plane.prototype.mouseToPlaneCoords=function(t,e){var i=this.htmlElement.getBoundingClientRect(),r=this.wrapper.container.getBoundingClientRect();return{x:(t-r.left-(i.left+window.pageXOffset))/this.htmlElement.clientWidth*2-1,y:1-(e-r.top-(i.top+window.pageYOffset))/this.htmlElement.clientHeight*2}},Plane.prototype._applyCSSPositions=function(){this.htmlElement.clientWidth,this.htmlElement.clientHeight;var t={top:this.htmlElement.getBoundingClientRect().top-this.wrapper.container.getBoundingClientRect().top,left:this.htmlElement.getBoundingClientRect().left-this.wrapper.container.getBoundingClientRect().left},e=this._documentToPlaneSpace(t.left,t.top);this.relativeTranslation={x:t.left,y:t.top},this.setTranslation(e.x,e.y,0)},Plane.prototype._setMVMatrix=function(){var t=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),e=this.translation.z-this.fov/2,i=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,this.translation.x,this.translation.y,e,1]),r=new Float32Array([1,0,0,0,0,Math.cos(this.rotation.x),Math.sin(this.rotation.x),0,0,-Math.sin(this.rotation.x),Math.cos(this.rotation.x),0,0,0,0,1]),s=new Float32Array([Math.cos(this.rotation.y),0,-Math.sin(this.rotation.y),0,0,1,0,0,Math.sin(this.rotation.y),0,Math.cos(this.rotation.y),0,0,0,0,1]),a=new Float32Array([Math.cos(this.rotation.z),Math.sin(this.rotation.z),0,0,-Math.sin(this.rotation.z),Math.cos(this.rotation.z),0,0,0,0,1,0,0,0,0,1]),n={x:this.scale.x*(this.wrapper.glCanvas.width/this.wrapper.glCanvas.height*this.geometry.innerScale.x/2),y:this.scale.y*this.geometry.innerScale.y/2},o=new Float32Array([n.x,0,0,0,0,n.y,0,0,0,0,1,0,0,0,0,1]),h=this._multiplyMatrix(t,i);return h=this._multiplyMatrix(h,r),h=this._multiplyMatrix(h,s),h=this._multiplyMatrix(h,a),h=this._multiplyMatrix(h,o)},Plane.prototype._planeResize=function(){var t=this.wrapper.glCanvas.width/this.wrapper.glCanvas.height;this.matrix.pMatrix=this._setPerspectiveMatrix(this.fov,.1,2*this.fov);var e=this.htmlElement.clientWidth,i=this.htmlElement.clientHeight;if(this.geometry.innerScale={x:e/this.wrapper.glCanvas.width,y:i/this.wrapper.glCanvas.height},this.clipSpace={x:(this.geometry.innerScale.x-1)*(t/2)/this.scale.x,y:(1-this.geometry.innerScale.y)/2/this.scale.y,width:t,height:2},this.mimicCSS?this._applyCSSPositions():this.setTranslation(this.translation.x,this.translation.y,this.translation.z),e!==this.size.width||i!==this.size.height)for(var r=0;r<this.images.length;r++)this._adjustTextureSize(r);this.size={width:e,height:i}},Plane.prototype.loadImages=function(t){for(var e,i=this,r=0;r<t.length;r++)(e=new Image).onload=function(){i.images.push(this),i.onPlaneLoadingCallback&&i.onPlaneLoadingCallback()},null!==i.crossOrigin&&void 0!==i.crossOrigin&&(e.crossOrigin=i.crossOrigin),e.sampler=t[r].getAttribute("data-sampler")||null,e.src=t[r].src;var s=setInterval(function(){i.images.length==t.length&&(clearInterval(s),i._reorderImages(t))},100);return this},Plane.prototype._reorderImages=function(t){for(var e=[],i=0;i<t.length;i++)for(var r=0;r<this.images.length;r++)this.images[r].src==t[i].src&&(e[i]=this.images[r]);this.images=e,this._createTexturesFromImages()},Plane.prototype._createTexturesFromImages=function(){this.wrapper._isInitialized();for(var t=0;t<this.images.length;t++){var e=this.wrapper.glContext.createTexture();this.wrapper.glContext.bindTexture(this.wrapper.glContext.TEXTURE_2D,e),this.wrapper.glContext.pixelStorei(this.wrapper.glContext.UNPACK_FLIP_Y_WEBGL,!0),this.wrapper.glContext.texParameteri(this.wrapper.glContext.TEXTURE_2D,this.wrapper.glContext.TEXTURE_WRAP_S,this.wrapper.glContext.CLAMP_TO_EDGE),this.wrapper.glContext.texParameteri(this.wrapper.glContext.TEXTURE_2D,this.wrapper.glContext.TEXTURE_WRAP_T,this.wrapper.glContext.CLAMP_TO_EDGE),this.wrapper.glContext.texParameteri(this.wrapper.glContext.TEXTURE_2D,this.wrapper.glContext.TEXTURE_MIN_FILTER,this.wrapper.glContext.LINEAR),this.wrapper.glContext.texParameteri(this.wrapper.glContext.TEXTURE_2D,this.wrapper.glContext.TEXTURE_MAG_FILTER,this.wrapper.glContext.LINEAR),e.index=this.wrapper.loadingManager.texturesLoaded,this.textures.push(e),this.wrapper.loadingManager.texturesLoaded++}this._setPlaneDefinition(this.definition.width,this.definition.height),this._texturesLoadedCallback&&this._texturesLoadedCallback()},Plane.prototype._adjustTextureSize=function(t){this.wrapper._isInitialized();window.devicePixelRatio;var e=this.images[t];if(this.imageCover){var i=document.createElement("canvas"),r=i.getContext("2d");i.width=this.htmlElement.clientWidth,i.height=this.htmlElement.clientHeight;var s=e.width/e.height,a=i.width/i.height,n=0,o=0;a>s?o=Math.min(0,(i.height-i.width*(1/s))/2):a<s&&(n=Math.min(0,(i.width-i.height*s)/2)),r.clearRect(0,0,i.width,i.height),r.drawImage(e,n/2,o/2,i.width-n,i.height-o),this.wrapper.glContext.useProgram(this.program),this.wrapper.glContext.activeTexture(this.wrapper.glContext.TEXTURE0+this.textures[t].index),this.wrapper.glContext.bindTexture(this.wrapper.glContext.TEXTURE_2D,this.textures[t]),this.wrapper.glContext.texImage2D(this.wrapper.glContext.TEXTURE_2D,0,this.wrapper.glContext.RGBA,this.wrapper.glContext.RGBA,this.wrapper.glContext.UNSIGNED_BYTE,i)}else this.wrapper.glContext.useProgram(this.program),this.wrapper.glContext.activeTexture(this.wrapper.glContext.TEXTURE0+this.textures[t].index),this.wrapper.glContext.bindTexture(this.wrapper.glContext.TEXTURE_2D,this.textures[t]),this.wrapper.glContext.texImage2D(this.wrapper.glContext.TEXTURE_2D,0,this.wrapper.glContext.RGBA,this.wrapper.glContext.RGBA,this.wrapper.glContext.UNSIGNED_BYTE,e)};
