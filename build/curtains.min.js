/***
    Little WebGL helper to apply images as textures of planes
    Author: Martin Laxenaire https://www.martin-laxenaire.fr/
    Version: 1.0
***/

function Curtains(t){this.planes=[];var e=t||"canvas";return this.container=document.getElementById(e),this.container?(this.loadingManager={texturesLoaded:0},this._init(),this):(console.warn("You must specify a valid container ID"),!1)}function Plane(t,e,i){this.wrapper=t,this.htmlElement=e,this.images=[],this.textures=[],this.index=this.wrapper.planes.length,this.canDraw=!1,this.definition={width:parseInt(i.widthSegments)||1,height:parseInt(i.heightSegments)||1},this.mimicCSS=i.mimicCSS,null!==this.mimicCSS&&void 0!==this.mimicCSS||(this.mimicCSS=!0),this.imageCover=i.imageCover,null!==this.imageCover&&void 0!==this.imageCover||(this.imageCover=!0),this.crossOrigin=i.crossOrigin,this.fov=i.fov||75;var r=i.vertexShaderID||e.getAttribute("data-vs-id"),s=i.fragmentShaderID||e.getAttribute("data-fs-id");if(!r||!s)return console.warn("No vertex or fragment shaders ID provided"),!1;var a=this.wrapper.glContext;if(this.program=a.createProgram(),this.shaders={},this.shaders.vertexShaderCode=document.getElementById(r).innerHTML,this.shaders.fragmentShaderCode=document.getElementById(s).innerHTML,this.shaders.vertexShader=this.wrapper._createShader(this.shaders.vertexShaderCode,a.VERTEX_SHADER),this.shaders.fragmentShader=this.wrapper._createShader(this.shaders.fragmentShaderCode,a.FRAGMENT_SHADER),!this.shaders.vertexShader||!this.shaders.fragmentShader)return console.warn("Unable to find the vertex or fragment shader"),this.wrapper.container.classList.add("no-webgl-curtains"),!1;if(a.attachShader(this.program,this.shaders.vertexShader),a.attachShader(this.program,this.shaders.fragmentShader),a.linkProgram(this.program),!a.getProgramParameter(this.program,a.LINK_STATUS))return console.warn("Unable to initialize the shader program."),this.wrapper.container.classList.add("no-webgl-curtains"),!1;a.useProgram(this.program),this.matrix={},this.matrix.mvMatrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.matrix.pMatrix=this._setPerspectiveMatrix(this.fov,.1,2*this.fov),this.scale={x:1,y:1},this.matrix.pMatrixUniform=a.getUniformLocation(this.program,"uPMatrix"),this.matrix.mvMatrixUniform=a.getUniformLocation(this.program,"uMVMatrix");return this._setAttributes({vertexPosition:"aVertexPosition",textureCoord:"aTextureCoord"}),this}Curtains.prototype._init=function(){this.glCanvas=document.createElement("canvas"),this.glContext&&(this.glContext.getExtension("WEBGL_lose_context").loseContext(),this.glContext=null),this.glContext=this.glCanvas.getContext("webgl",{alpha:!0})||this.glCanvas.getContext("experimental-webgl"),this.glCanvas.width=this.container.clientWidth,this.glCanvas.height=this.container.clientHeight,this.glContext.viewport(0,0,this.glCanvas.width,this.glCanvas.height),this._readyToDraw()},Curtains.prototype._isInitialized=function(){if(!this.glCanvas||!this.glContext)return console.warn("No WebGL canvas or context"),!1},Curtains.prototype.dispose=function(){window.cancelAnimationFrame(this.requestAnimationFrameID),this.glContext&&(this.glContext.getExtension("WEBGL_lose_context").loseContext(),this.glContext=null)},Curtains.prototype._createPlane=function(t,e){var i=new Plane(this,t,e);return this.planes.push(i),i},Curtains.prototype.addPlane=function(t,e){if(!t||0===t.length)return console.warn("The html element you specified does not currently exists in the DOM"),!1;for(var i=this._createPlane(t,e),r=[],s=0;s<i.htmlElement.getElementsByTagName("img").length;s++)r.push(i.htmlElement.getElementsByTagName("img")[s]);return r.length>0?i.loadImages(r):console.warn("This plane does not contain any image element. You may want to add some later with the loadImages method."),e.uniforms||(e.uniforms={},console.warn("You are setting a plane without uniforms, you won't be able to interact with it. Please check your addPlane method for : ",i.htmlElement)),i._setUniforms(e.uniforms),i},Curtains.prototype._createShader=function(t,e){this._isInitialized();var i=this.glContext.createShader(e);return this.glContext.shaderSource(i,t),this.glContext.compileShader(i),this.glContext.getShaderParameter(i,this.glContext.COMPILE_STATUS)?i:(console.log("Errors occurred while compiling the shader:\n"+this.glContext.getShaderInfoLog(i)),this.container.classList.add("no-webgl-curtains"),null)},Curtains.prototype._reSize=function(){if(this.glCanvas.width!==Math.floor(this.container.clientWidth)||this.glCanvas.height!==Math.floor(this.container.clientHeight)){this.glCanvas.width=Math.floor(this.container.clientWidth),this.glCanvas.height=Math.floor(this.container.clientHeight),this.glContext.viewport(0,0,this.glCanvas.width,this.glCanvas.height);for(var t=0;t<this.planes.length;t++)this.planes[t].canDraw&&this.planes[t].planeResize()}},Curtains.prototype._readyToDraw=function(){this._isInitialized(),this.container.appendChild(this.glCanvas),this.glContext.enable(this.glContext.DEPTH_TEST),this.glContext.blendFunc(this.glContext.SRC_ALPHA,this.glContext.ONE_MINUS_SRC_ALPHA),this.glContext.enable(this.glContext.BLEND),console.log("curtains.js - v1.0");var t=this;!function e(){t._drawScene(),t.requestAnimationFrameID=window.requestAnimationFrame(e)}()},Curtains.prototype._drawScene=function(){this._isInitialized(),this.glContext.clearColor(0,0,0,0),this.glContext.clearDepth(1),this._reSize();for(var t=0;t<this.planes.length;t++){var e=this.planes[t];if(this.glContext.isProgram(e.program)&&e.canDraw){this.glContext.useProgram(e.program),e.onRenderCallback&&e.onRenderCallback();for(var i=0;i<e.textures.length;i++)this.glContext.activeTexture(this.glContext.TEXTURE0+e.textures[i].index),this.glContext.bindTexture(this.glContext.TEXTURE_2D,e.textures[i]);e._updateUniforms(),e._bindPlaneBuffers(),this.glContext.uniformMatrix4fv(e.matrix.pMatrixUniform,!1,e.matrix.pMatrix),this.glContext.uniformMatrix4fv(e.matrix.mvMatrixUniform,!1,e.matrix.mvMatrix),this.glContext.drawArrays(this.glContext.TRIANGLES,0,e.geometry.verticesBuffer.numberOfItems)}}},Plane.prototype._isProgramInitialized=function(){if(!this.program)return console.warn("No WebGL program for this plane"),!1},Plane.prototype.onLoading=function(t){return t&&(this.onPlaneLoadingCallback=t),this},Plane.prototype.planeTexturesLoaded=function(t){return t&&(this._texturesLoadedCallback=t),this},Plane.prototype.onReady=function(t){return t&&(this._onReadyCallback=t),this},Plane.prototype.onRender=function(t){return t&&(this.onRenderCallback=t),this},Plane.prototype._setPlaneDefinition=function(t,e){var i=this.wrapper.glContext;i.useProgram(this.program);for(var r=0;r<this.textures.length;r++)if(this.images[r].sampler){var s=this.images[r].sampler;this.uniforms[s]={},this.uniforms[s].location=i.getUniformLocation(this.program,s),this.uniforms[s].coreUniform=!0,i.uniform1i(this.uniforms[s].location,this.textures[r].index)}else this.uniforms["sampler"+this.textures[r].index]={},this.uniforms["sampler"+this.textures[r].index].location=i.getUniformLocation(this.program,"uSampler"+r),this.uniforms["sampler"+this.textures[r].index].coreUniform=!0,i.uniform1i(this.uniforms["sampler"+this.textures[r].index].location,this.textures[r].index);this._initializeBuffers(t,e)},Plane.prototype._setPlaneVertices=function(t,e){for(var i={vertices:[],uvs:[]},r=0;r<e;++r)for(var s=r/e,a=0;a<t;++a){var n=a/t;i.uvs.push(n),i.uvs.push(s),i.uvs.push(0),i.vertices.push(2*(n-.5)),i.vertices.push(2*(s-.5)),i.vertices.push(0),i.uvs.push(n+1/t),i.uvs.push(s),i.uvs.push(0),i.vertices.push(2*(n+1/t-.5)),i.vertices.push(2*(s-.5)),i.vertices.push(0),i.uvs.push(n),i.uvs.push(s+1/e),i.uvs.push(0),i.vertices.push(2*(n-.5)),i.vertices.push(2*(s+1/e-.5)),i.vertices.push(0),i.uvs.push(n),i.uvs.push(s+1/e),i.uvs.push(0),i.vertices.push(2*(n-.5)),i.vertices.push(2*(s+1/e-.5)),i.vertices.push(0),i.uvs.push(n+1/t),i.uvs.push(s+1/e),i.uvs.push(0),i.vertices.push(2*(n+1/t-.5)),i.vertices.push(2*(s+1/e-.5)),i.vertices.push(0),i.uvs.push(n+1/t),i.uvs.push(s),i.uvs.push(0),i.vertices.push(2*(n+1/t-.5)),i.vertices.push(2*(s-.5)),i.vertices.push(0)}return i},Plane.prototype._initializeBuffers=function(t,e){this.wrapper._isInitialized(),this._isProgramInitialized(),t=Math.floor(t)||1,e=Math.floor(e)||1,planeWidth=this.htmlElement.clientWidth||this.wrapper.glCanvas.width,planeHeight=this.htmlElement.clientHeight||this.wrapper.glCanvas.height,this.size={width:planeWidth,height:planeHeight},this.geometry={},this.geometry.innerScale={x:planeWidth/this.wrapper.glCanvas.width,y:planeHeight/this.wrapper.glCanvas.height},this.clipSpace={x:(this.geometry.innerScale.x-1)*(this.wrapper.glCanvas.width/this.wrapper.glCanvas.height/2)/this.scale.x,y:(1-this.geometry.innerScale.y)/2/this.scale.y,width:this.wrapper.glCanvas.width/this.wrapper.glCanvas.height,height:2},this.rotation={x:0,y:0,z:0},this.relativeTranslation={x:0,y:0},this.mimicCSS?this._applyCSSPositions():this.setTranslation(0,0,0);for(var i=0;i<this.textures.length;i++)this._adjustTextureSize(i);var r=this._setPlaneVertices(t,e),s=this.wrapper.glContext;this.geometry.vertices=r.vertices,this.geometry.verticesBuffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,this.geometry.verticesBuffer),s.bufferData(s.ARRAY_BUFFER,new Float32Array(this.geometry.vertices),s.STATIC_DRAW),this.geometry.verticesBuffer.itemSize=3,this.geometry.verticesBuffer.numberOfItems=this.geometry.vertices.length/this.geometry.verticesBuffer.itemSize,this.material={},this.material.uvs=r.uvs,this.material.texCoordBuffer=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,this.material.texCoordBuffer),s.bufferData(s.ARRAY_BUFFER,new Float32Array(this.material.uvs),s.STATIC_DRAW),this.material.texCoordBuffer.itemSize=3,this.material.texCoordBuffer.numberOfItems=this.material.uvs.length/this.material.texCoordBuffer.itemSize,this.canDraw=!0,this._onReadyCallback&&this._onReadyCallback()},Plane.prototype._bindPlaneBuffers=function(){this.wrapper._isInitialized(),this._isProgramInitialized();var t=this.wrapper.glContext;t.bindBuffer(t.ARRAY_BUFFER,this.geometry.verticesBuffer),t.vertexAttribPointer(this.attributes.vertexPosition,this.geometry.verticesBuffer.itemSize,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.attributes.vertexPosition),t.bindBuffer(t.ARRAY_BUFFER,this.material.texCoordBuffer),t.vertexAttribPointer(this.attributes.textureCoord,this.material.texCoordBuffer.itemSize,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.attributes.textureCoord)},Plane.prototype._setAttributes=function(t){this.wrapper._isInitialized(),this._isProgramInitialized(),this.attributes||(this.attributes={});var e=this;Object.keys(t).map(function(i,r){var s=t[i];e.attributes[i]=e.wrapper.glContext.getAttribLocation(e.program,s)})},Plane.prototype._handleUniformSetting=function(t,e,i){var r=this.wrapper.glContext;"1i"==t?r.uniform1i(e,i):"1iv"==t?r.uniform1iv(e,i):"1f"==t?r.uniform1f(e,i):"1fv"==t?r.uniform1fv(e,i):"2i"==t?r.uniform2i(e,i[0],i[1]):"2iv"==t?r.uniform2iv(e,i):"2f"==t?r.uniform2f(e,i[0],i[1]):"2fv"==t?r.uniform2fv(e,i):"3i"==t?r.uniform3i(e,i[0],i[1],i[2]):"3iv"==t?r.uniform3iv(e,i):"3f"==t?r.uniform3f(e,i[0],i[1],i[2]):"3fv"==t?r.uniform3fv(e,i):"4i"==t?r.uniform4i(e,i[0],i[1],i[2],i[3]):"4iv"==t?r.uniform4iv(e,i):"4f"==t?r.uniform4f(e,i[0],i[1],i[2],i[3]):"4fv"==t?r.uniform4fv(e,i):console.log("This uniform type is not handled : ",t)},Plane.prototype._setUniforms=function(t){this.wrapper._isInitialized(),this._isProgramInitialized(),this.wrapper.glContext.useProgram(this.program),this.uniforms||(this.uniforms={});var e=this;t&&Object.keys(t).map(function(i,r){var s=t[i];e.uniforms[i]={location:e.wrapper.glContext.getUniformLocation(e.program,s.name),name:s.name,type:s.type,value:s.value,coreUniform:!1},e._handleUniformSetting(s.type,e.uniforms[i].location,s.value)})},Plane.prototype._updateUniforms=function(){if(this.wrapper._isInitialized(),this._isProgramInitialized(),this.wrapper.glContext.useProgram(this.program),this.uniforms&&this.wrapper.glContext.isProgram(this.program)){var t=this.uniforms,e=this;Object.keys(t).map(function(i,r){var s=t[i];if(!s.coreUniform){var a=s.location,n=s.value,o=s.type;e._handleUniformSetting(o,a,n)}})}},Plane.prototype._multiplyMatrix=function(t,e){var i=[],r=t[0],s=t[1],a=t[2],n=t[3],o=t[4],h=t[5],l=t[6],p=t[7],u=t[8],m=t[9],g=t[10],c=t[11],f=t[12],d=t[13],v=t[14],x=t[15],C=e[0],y=e[1],w=e[2],_=e[3];return i[0]=C*r+y*o+w*u+_*f,i[1]=C*s+y*h+w*m+_*d,i[2]=C*a+y*l+w*g+_*v,i[3]=C*n+y*p+w*c+_*x,C=e[4],y=e[5],w=e[6],_=e[7],i[4]=C*r+y*o+w*u+_*f,i[5]=C*s+y*h+w*m+_*d,i[6]=C*a+y*l+w*g+_*v,i[7]=C*n+y*p+w*c+_*x,C=e[8],y=e[9],w=e[10],_=e[11],i[8]=C*r+y*o+w*u+_*f,i[9]=C*s+y*h+w*m+_*d,i[10]=C*a+y*l+w*g+_*v,i[11]=C*n+y*p+w*c+_*x,C=e[12],y=e[13],w=e[14],_=e[15],i[12]=C*r+y*o+w*u+_*f,i[13]=C*s+y*h+w*m+_*d,i[14]=C*a+y*l+w*g+_*v,i[15]=C*n+y*p+w*c+_*x,i},Plane.prototype._setPerspectiveMatrix=function(t,e,i){var r=this.wrapper.glCanvas.width/this.wrapper.glCanvas.height;return t!==this.fov&&(this.fov=t),[t/r,0,0,0,0,t,0,0,0,0,(e+i)*(1/(e-i)),-1,0,0,e*i*(1/(e-i))*2,0]},Plane.prototype.setPerspective=function(t,e,i){var r=parseInt(t)||75;r<0?r=0:r>180&&(r=180);var s=parseFloat(e)||.1,a=parseFloat(i)||100,n=this.translation.x||0,o=this.translation.y||0;this.matrix.pMatrix=this._setPerspectiveMatrix(r,s,a),this.setTranslation(n,o,0)},Plane.prototype.setScale=function(t,e){this.wrapper._isInitialized(),this._isProgramInitialized(),t=parseFloat(t)||1,t=Math.max(t,.001),e=parseFloat(e)||1,e=Math.max(e,.001),this.scale={x:t,y:e},this.matrix.mvMatrix=this._setMVMatrix()},Plane.prototype.setRotation=function(t,e,i){this.wrapper._isInitialized(),this._isProgramInitialized(),t=parseFloat(t)||0,e=parseFloat(e)||0,i=parseFloat(i)||0,this.rotation={x:t,y:e,z:i},this.matrix.mvMatrix=this._setMVMatrix()},Plane.prototype.setTranslation=function(t,e,i){this.wrapper._isInitialized(),this._isProgramInitialized(),t=t||0,e=e||0,i=i||0,this.translation={x:t,y:e,z:i},this.matrix.mvMatrix=this._setMVMatrix()},Plane.prototype.setRelativePosition=function(t,e){var i=this._documentToPlaneSpace(t,e);this.relativeTranslation={x:t,y:e},this.setTranslation(i.x,i.y,this.translation.z)},Plane.prototype._documentToPlaneSpace=function(t,e){return{x:this.clipSpace.x+t/this.wrapper.glCanvas.width*this.clipSpace.width,y:this.clipSpace.y-e/this.wrapper.glCanvas.height}},Plane.prototype.mouseToPlaneCoords=function(t,e){var i=this.htmlElement.getBoundingClientRect(),r=this.wrapper.container.getBoundingClientRect();return{x:(t-r.left-(i.left+window.pageXOffset))/this.size.width*2-1,y:1-(e-r.top-(i.top+window.pageYOffset))/this.size.height*2}},Plane.prototype._applyCSSPositions=function(){this.size.width,this.size.height;var t={top:this.htmlElement.getBoundingClientRect().top-this.wrapper.container.getBoundingClientRect().top,left:this.htmlElement.getBoundingClientRect().left-this.wrapper.container.getBoundingClientRect().left},e=this._documentToPlaneSpace(t.left,t.top);this.relativeTranslation={x:t.left,y:t.top},this.setTranslation(e.x,e.y,0)},Plane.prototype._setMVMatrix=function(){var t=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),e=this.translation.z-this.fov/2,i=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,this.translation.x,this.translation.y,e,1]),r=new Float32Array([1,0,0,0,0,Math.cos(this.rotation.x),Math.sin(this.rotation.x),0,0,-Math.sin(this.rotation.x),Math.cos(this.rotation.x),0,0,0,0,1]),s=new Float32Array([Math.cos(this.rotation.y),0,-Math.sin(this.rotation.y),0,0,1,0,0,Math.sin(this.rotation.y),0,Math.cos(this.rotation.y),0,0,0,0,1]),a=new Float32Array([Math.cos(this.rotation.z),Math.sin(this.rotation.z),0,0,-Math.sin(this.rotation.z),Math.cos(this.rotation.z),0,0,0,0,1,0,0,0,0,1]),n={x:this.scale.x*(this.wrapper.glCanvas.width/this.wrapper.glCanvas.height*this.geometry.innerScale.x/2),y:this.scale.y*this.geometry.innerScale.y/2},o=new Float32Array([n.x,0,0,0,0,n.y,0,0,0,0,1,0,0,0,0,1]),h=this._multiplyMatrix(t,i);return h=this._multiplyMatrix(h,r),h=this._multiplyMatrix(h,s),h=this._multiplyMatrix(h,a),h=this._multiplyMatrix(h,o)},Plane.prototype.planeResize=function(){var t=this.wrapper.glCanvas.width/this.wrapper.glCanvas.height;this.matrix.pMatrix=this._setPerspectiveMatrix(this.fov,.1,2*this.fov);var e=this.htmlElement.clientWidth,i=this.htmlElement.clientHeight;if(!e&&!i){var r=document.getElementsByClassName(this.htmlElement.className);if(r.length>0)for(var s=0;s<r.length;s++)r[s].isEqualNode(this.htmlElement)&&(this.htmlElement=r[s],e=this.htmlElement.clientWidth,i=this.htmlElement.clientHeight)}if(e&&i){var a=!1;if(e===this.size.width&&i===this.size.height||(a=!0),this.size={width:e,height:i},this.geometry.innerScale={x:e/this.wrapper.glCanvas.width,y:i/this.wrapper.glCanvas.height},this.clipSpace={x:(this.geometry.innerScale.x-1)*(t/2)/this.scale.x,y:(1-this.geometry.innerScale.y)/2/this.scale.y,width:t,height:2},this.mimicCSS?this._applyCSSPositions():this.setTranslation(this.translation.x,this.translation.y,this.translation.z),a)for(s=0;s<this.images.length;s++)this._adjustTextureSize(s)}},Plane.prototype.loadImages=function(t){for(var e,i=this,r=0;r<t.length;r++)(e=new Image).onload=function(){i.images.push(this),i.onPlaneLoadingCallback&&i.onPlaneLoadingCallback()},null!==i.crossOrigin&&void 0!==i.crossOrigin&&(e.crossOrigin=i.crossOrigin),e.sampler=t[r].getAttribute("data-sampler")||null,e.src=t[r].src;var s=setInterval(function(){i.images.length==t.length&&(clearInterval(s),i._reorderImages(t))},100);return this},Plane.prototype._reorderImages=function(t){for(var e=[],i=0;i<t.length;i++)for(var r=0;r<this.images.length;r++)this.images[r].src==t[i].src&&(e[i]=this.images[r]);this.images=e,this._createTexturesFromImages()},Plane.prototype._createTexturesFromImages=function(){this.wrapper._isInitialized();for(var t=this.wrapper.glContext,e=0;e<this.images.length;e++){var i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),i.index=this.wrapper.loadingManager.texturesLoaded,this.textures.push(i),this.wrapper.loadingManager.texturesLoaded++}this._setPlaneDefinition(this.definition.width,this.definition.height),this._texturesLoadedCallback&&this._texturesLoadedCallback()},Plane.prototype._adjustTextureSize=function(t){this.wrapper._isInitialized();window.devicePixelRatio;var e=this.images[t],i=this.wrapper.glContext;if(this.imageCover){var r=document.createElement("canvas"),s=r.getContext("2d");r.width=this.size.width,r.height=this.size.height;var a=e.width/e.height,n=r.width/r.height,o=0,h=0;n>a?h=Math.min(0,(r.height-r.width*(1/a))/2):n<a&&(o=Math.min(0,(r.width-r.height*a)/2)),s.clearRect(0,0,r.width,r.height),s.drawImage(e,o,h,r.width-2*o,r.height-2*h),i.useProgram(this.program),i.activeTexture(i.TEXTURE0+this.textures[t].index),i.bindTexture(i.TEXTURE_2D,this.textures[t]),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,r)}else i.useProgram(this.program),i.activeTexture(i.TEXTURE0+this.textures[t].index),i.bindTexture(i.TEXTURE_2D,this.textures[t]),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e)};
