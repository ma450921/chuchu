function Curtains(e,t){return(this.planes=[],this._drawStack=[],this._drawingEnabled=!0,this._forceRender=!1,this.container=document.getElementById(e||"canvas"),this.productionMode=t||!1,!this.container)?(this.productionMode||console.warn("You must specify a valid container ID"),void(this._onErrorCallback&&this._onErrorCallback())):(this._init(),this)}Curtains.prototype._init=function(){if(this.glCanvas=document.createElement("canvas"),this.glContext=this.glCanvas.getContext("webgl",{alpha:!0})||this.glCanvas.getContext("experimental-webgl"),!this.glContext)return this.productionMode||console.warn("WebGL context could not be created"),void(this._onErrorCallback&&this._onErrorCallback());var e=window.pixelRatio||1;this.setPixelRatio(e),this._loseContextExtension=this.glContext.getExtension("WEBGL_lose_context"),this._contextLostHandler=this._contextLost.bind(this),this.glCanvas.addEventListener("webglcontextlost",this._contextLostHandler,!1),this._contextRestoredHandler=this._contextRestored.bind(this),this.glCanvas.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._resizeHandler=this.resize.bind(this),window.addEventListener("resize",this._resizeHandler,!1),this._readyToDraw()},Curtains.prototype.setPixelRatio=function(e){this.pixelRatio=parseFloat(Math.max(e,1))||1,this.resize()},Curtains.prototype._setSize=function(){var e=this.container.getBoundingClientRect();this._boundingRect={width:e.width*this.pixelRatio,height:e.height*this.pixelRatio,top:e.top*this.pixelRatio,left:e.left*this.pixelRatio},this.glCanvas.style.width=Math.floor(this._boundingRect.width/this.pixelRatio)+"px",this.glCanvas.style.height=Math.floor(this._boundingRect.height/this.pixelRatio)+"px",this.glCanvas.width=Math.floor(this._boundingRect.width),this.glCanvas.height=Math.floor(this._boundingRect.height),this.glContext.viewport(0,0,this.glContext.drawingBufferWidth,this.glContext.drawingBufferHeight)},Curtains.prototype.resize=function(){this._setSize();for(var e=0;e<this.planes.length;e++)this.planes[e]._canDraw&&this.planes[e].planeResize();this.needRender()},Curtains.prototype.enableDrawing=function(){this._drawingEnabled=!0},Curtains.prototype.disableDrawing=function(){this._drawingEnabled=!1},Curtains.prototype.needRender=function(){this._forceRender=!0},Curtains.prototype._contextLost=function(e){e.preventDefault(),this._animationFrameID&&window.cancelAnimationFrame(this._animationFrameID);var t=this;setTimeout(function(){t._onContextLostCallback&&t._onContextLostCallback()},0)},Curtains.prototype.restoreContext=function(){this.glContext&&this._loseContextExtension?this._loseContextExtension.restoreContext():!this.productionMode&&(this.glContext?!this._loseContextExtension&&console.warn("Could not restore context because the restore context extension is not defined"):console.warn("Could not restore context because the context is not defined"))},Curtains.prototype._contextRestored=function(){for(var e=0;e<this.planes.length;e++)this.planes[e]._restoreContext();var t=this;setTimeout(function(){t._onContextRestoredCallback&&t._onContextRestoredCallback()},0),this.needRender(),this._animate()},Curtains.prototype.dispose=function(){for(;0<this.planes.length;)this.removePlane(this.planes[0]);var e=this,t=setInterval(function(){0===e.planes.length&&(clearInterval(t),e.glContext.clear(e.glContext.DEPTH_BUFFER_BIT|e.glContext.COLOR_BUFFER_BIT),window.cancelAnimationFrame(e._animationFrameID),window.removeEventListener("resize",e._resizeHandler,!1),e.glCanvas.removeEventListener("webglcontextlost",e._contextLostHandler,!1),e.glCanvas.removeEventListener("webglcontextrestored",e._contextRestoredHandler,!1),e.glContext&&e._loseContextExtension&&e._loseContextExtension.loseContext(),e.container.removeChild(e.glCanvas))},100)},Curtains.prototype._createPlane=function(e,t){var o=new Curtains.Plane(this,e,t);return o},Curtains.prototype.addPlane=function(e,t){if(!this.glContext)return this.productionMode||console.warn("Unable to create a plane. The WebGl context couldn't be created"),this._onErrorCallback&&this._onErrorCallback(),null;if(!e||0===e.length)return this.productionMode||console.warn("The html element you specified does not currently exists in the DOM"),this._onErrorCallback&&this._onErrorCallback(),!1;var o=this._createPlane(e,t);return o},Curtains.prototype.removePlane=function(e){e._canDraw=!1;for(var t=this._drawStack,o=0;o<t.length;o++)e.index===t[o]&&this._drawStack.splice(o,1);e&&e._dispose();for(var r,o=0;o<this.planes.length;o++)e.index===this.planes[o].index&&(r=o);e=null,this.planes[r]=null,this.planes.splice(r,1),this.glContext&&this.glContext.clear(this.glContext.DEPTH_BUFFER_BIT|this.glContext.COLOR_BUFFER_BIT)},Curtains.prototype._stackPlane=function(e){this._drawStack.push(e)},Curtains.prototype._createShader=function(e,t){var o=this.glContext.createShader(t);return this.glContext.shaderSource(o,e),this.glContext.compileShader(o),this.glContext.getShaderParameter(o,this.glContext.COMPILE_STATUS)?o:(this.productionMode||console.warn("Errors occurred while compiling the shader:\n"+this.glContext.getShaderInfoLog(o)),this._onErrorCallback&&this._onErrorCallback(),null)},Curtains.prototype._handleDepth=function(e){this._shouldHandleDepth=e,e?this.glContext.enable(this.glContext.DEPTH_TEST):this.glContext.disable(this.glContext.DEPTH_TEST)},Curtains.prototype._readyToDraw=function(){this.container.appendChild(this.glCanvas),this.glContext.blendFunc(this.glContext.SRC_ALPHA,this.glContext.ONE_MINUS_SRC_ALPHA),this.glContext.enable(this.glContext.BLEND),this._handleDepth(!0),console.log("curtains.js - v2.0"),this._animate()},Curtains.prototype._animate=function(){this._drawScene(),this._animationFrameID=window.requestAnimationFrame(this._animate.bind(this))},Curtains.prototype._drawScene=function(){if(this._drawingEnabled||this._forceRender){this._forceRender&&(this._forceRender=!1),this.__onRenderCallback&&this.__onRenderCallback(),this.glContext.clearColor(0,0,0,0),this.glContext.clearDepth(1);for(var e,t=0;t<this._drawStack.length;t++)e=this.planes[this._drawStack[t]],e&&(e._shouldUseDepthTest&&!this._shouldHandleDepth?this._handleDepth(!0):!e._shouldUseDepthTest&&this._shouldHandleDepth&&this._handleDepth(!1),e._drawPlane())}},Curtains.prototype.onError=function(e){return e&&(this._onErrorCallback=e),this},Curtains.prototype.onContextLost=function(e){return e&&(this._onContextLostCallback=e),this},Curtains.prototype.onContextRestored=function(e){return e&&(this._onContextRestoredCallback=e),this},Curtains.prototype.onRender=function(e){return e&&(this.__onRenderCallback=e),this},Curtains.Plane=function(e,t,o){return this._wrapper=e,this.htmlElement=t,this.index=this._wrapper.planes.length,this._init(t,o),this._wrapper.planes.push(this),this},Curtains.Plane.prototype._init=function(e,t){t||(t={}),this._setupShaders(t);var o=this._setupPlaneProgram();if(this._setInitParams(t),this.images=[],this.videos=[],this.canvases=[],this.textures=[],o){this._setAttributes();var r=this._wrapper;if(this._setDocumentSizes(),this._setComputedSizes(),this.scale={x:1,y:1},this.rotation={x:0,y:0,z:0},this.relativeTranslation={x:0,y:0},this._translation={x:0,y:0,z:0},r._stackPlane(this.index),this._setUniforms(this.uniforms),this._initializeBuffers(),this._loadingManager={sourcesLoaded:0,initSourcesToLoad:0},this.autoloadSources){for(var a=[],n=0;n<this.htmlElement.getElementsByTagName("img").length;n++)a.push(this.htmlElement.getElementsByTagName("img")[n]);0<a.length&&this.loadSources(a);for(var l=[],n=0;n<this.htmlElement.getElementsByTagName("video").length;n++)l.push(this.htmlElement.getElementsByTagName("video")[n]);0<l.length&&this.loadSources(l);for(var d=[],n=0;n<this.htmlElement.getElementsByTagName("canvas").length;n++)d.push(this.htmlElement.getElementsByTagName("canvas")[n]);0<d.length&&this.loadSources(d),this._loadingManager.initSourcesToLoad=a.length+l.length+d.length}0!==this._loadingManager.initSourcesToLoad||r.productionMode||console.warn("This plane does not contain any image, video or canvas element. You may want to add some later with the loadSource() or loadSources() method.");var s,p=this;s=setInterval(function(){p._loadingManager.sourcesLoaded>=p._loadingManager.initSourcesToLoad&&(clearInterval(s),p._onReadyCallback&&p._onReadyCallback())},16)}},Curtains.Plane.prototype._setInitParams=function(e){var t=this._wrapper;this._canDraw=!1,this.alwaysDraw=e.alwaysDraw||!1,this._shouldDraw=!0,this._definition={width:parseInt(e.widthSegments)||1,height:parseInt(e.heightSegments)||1},(e.mimicCSS||!1===e.mimicCSS)&&!t.productionMode&&console.warn("mimicCSS property is deprecated since v2.0 as the planes will always copy their html elements sizes and positions."),this.imageCover=e.imageCover||!1,this.imageCover&&!t.productionMode&&console.warn("imageCover property is deprecated. Please use texture matrix in your shader instead."),this.autoloadSources=e.autoloadSources,(null===this.autoloadSources||this.autoloadSources===void 0)&&(this.autoloadSources=!0),this.crossOrigin=e.crossOrigin||"anonymous",this._fov=e._fov||75,this._shouldUseDepthTest=!0,e.uniforms||(!t.productionMode&&console.warn("You are setting a plane without uniforms, you won't be able to interact with it. Please check your addPlane method for : ",this.htmlElement),e.uniforms={}),this.uniforms={};var o=this;e.uniforms&&Object.keys(e.uniforms).map(function(t){var r=e.uniforms[t];o.uniforms[t]={name:r.name,type:r.type,value:r.value}})},Curtains.Plane.prototype._setupShaders=function(e){var t,o,r=this._wrapper,a=e.vertexShaderID||this.htmlElement.getAttribute("data-vs-id"),n=e.fragmentShaderID||this.htmlElement.getAttribute("data-fs-id");e.vertexShader||(a&&document.getElementById(a)?t=document.getElementById(a).innerHTML:(!r.productionMode&&console.warn("No vertex shader provided, will use a default one"),t="#ifdef GL_ES\nprecision mediump float;\n#endif\nattribute vec3 aVertexPosition;attribute vec2 aTextureCoord;uniform mat4 uMVMatrix;uniform mat4 uPMatrix;varying vec3 vVertexPosition;varying vec2 vTextureCoord;void main() {vTextureCoord = aTextureCoord;vVertexPosition = aVertexPosition;gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);}")),e.fragmentShader||(n&&document.getElementById(n)?o=document.getElementById(n).innerHTML:(!r.productionMode&&console.warn("No fragment shader provided, will use a default one"),o="#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec3 vVertexPosition;varying vec2 vTextureCoord;void main( void ) {gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);}")),this._shaders={vertexShaderCode:e.vertexShader||t,fragmentShaderCode:e.fragmentShader||o}},Curtains.Plane.prototype._setupPlaneProgram=function(){var e=!0,t=this._wrapper,o=t.glContext;return this._program=o.createProgram(),this._shaders.vertexShader=t._createShader(this._shaders.vertexShaderCode,o.VERTEX_SHADER),this._shaders.fragmentShader=t._createShader(this._shaders.fragmentShaderCode,o.FRAGMENT_SHADER),this._shaders.vertexShader&&this._shaders.fragmentShader||t.productionMode||(!t.productionMode&&console.warn("Unable to find or compile the vertex or fragment shader"),this._onErrorCallback&&this._onErrorCallback(),e=!1),e&&(o.attachShader(this._program,this._shaders.vertexShader),o.attachShader(this._program,this._shaders.fragmentShader),o.linkProgram(this._program),!o.getProgramParameter(this._program,o.LINK_STATUS)&&(!t.productionMode&&console.warn("Unable to initialize the shader program."),this._onErrorCallback&&this._onErrorCallback(),e=!1),this._matrices={mvMatrix:{name:"uMVMatrix",matrix:new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),location:o.getUniformLocation(this._program,"uMVMatrix")},pMatrix:{name:"uPMatrix",matrix:new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),location:o.getUniformLocation(this._program,"uPMatrix")}}),e},Curtains.Plane.prototype._setDocumentSizes=function(){var e=this._wrapper,t=this.htmlElement.getBoundingClientRect();0===t.width&&0===t.height&&(t=e._boundingRect),this._boundingRect={document:{width:t.width*e.pixelRatio,height:t.height*e.pixelRatio,top:t.top*e.pixelRatio,left:t.left*e.pixelRatio}}},Curtains.Plane.prototype._setComputedSizes=function(){var e=this._wrapper,t={x:this._boundingRect.document.width/2+this._boundingRect.document.left,y:this._boundingRect.document.height/2+this._boundingRect.document.top},o={x:e._boundingRect.width/2+e._boundingRect.left,y:e._boundingRect.height/2+e._boundingRect.top};this._boundingRect.computed={width:this._boundingRect.document.width/e._boundingRect.width,height:this._boundingRect.document.height/e._boundingRect.height,top:(o.y-t.y)/e._boundingRect.height,left:(t.x-o.x)/e._boundingRect.height}},Curtains.Plane.prototype._restoreContext=function(){this._canDraw=!1,this._shaders.vertexShader=null,this._shaders.fragmentShader=null,this._program=null,this._matrices=null,this._attributes=null,this._geometry.bufferInfos=null,this._material.bufferInfos=null;var e=this._setupPlaneProgram();if(e){this._setAttributes(),this._setUniforms(this.uniforms),this._initializeBuffers();for(var t,o=0;o<this.textures.length;o++)t=this.textures[o].source,this.textures[o]._init(),this.textures[o].setSource(t)}},Curtains.Plane.prototype._setPlaneVertices=function(){this._geometry={vertices:[]},this._material={uvs:[]};for(var e,t=0;t<this._definition.height;++t){e=t/this._definition.height;for(var o,r=0;r<this._definition.width;++r)o=r/this._definition.width,this._material.uvs.push(o),this._material.uvs.push(e),this._material.uvs.push(0),this._geometry.vertices.push(2*(o-.5)),this._geometry.vertices.push(2*(e-.5)),this._geometry.vertices.push(0),this._material.uvs.push(o+1/this._definition.width),this._material.uvs.push(e),this._material.uvs.push(0),this._geometry.vertices.push(2*(o+1/this._definition.width-.5)),this._geometry.vertices.push(2*(e-.5)),this._geometry.vertices.push(0),this._material.uvs.push(o),this._material.uvs.push(e+1/this._definition.height),this._material.uvs.push(0),this._geometry.vertices.push(2*(o-.5)),this._geometry.vertices.push(2*(e+1/this._definition.height-.5)),this._geometry.vertices.push(0),this._material.uvs.push(o),this._material.uvs.push(e+1/this._definition.height),this._material.uvs.push(0),this._geometry.vertices.push(2*(o-.5)),this._geometry.vertices.push(2*(e+1/this._definition.height-.5)),this._geometry.vertices.push(0),this._material.uvs.push(o+1/this._definition.width),this._material.uvs.push(e+1/this._definition.height),this._material.uvs.push(0),this._geometry.vertices.push(2*(o+1/this._definition.width-.5)),this._geometry.vertices.push(2*(e+1/this._definition.height-.5)),this._geometry.vertices.push(0),this._material.uvs.push(o+1/this._definition.width),this._material.uvs.push(e),this._material.uvs.push(0),this._geometry.vertices.push(2*(o+1/this._definition.width-.5)),this._geometry.vertices.push(2*(e-.5)),this._geometry.vertices.push(0)}},Curtains.Plane.prototype._initializeBuffers=function(){var e=this._wrapper,t=e.glContext;this._geometry||this._material||this._setPlaneVertices(),this._applyCSSPositions(),this.setPerspective(this._fov,.1,2*this._fov);this._attributes&&(this._geometry.bufferInfos={id:t.createBuffer(),itemSize:3,numberOfItems:this._geometry.vertices.length/3},t.bindBuffer(t.ARRAY_BUFFER,this._geometry.bufferInfos.id),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this._geometry.vertices),t.STATIC_DRAW),t.vertexAttribPointer(this._attributes.vertexPosition.location,this._geometry.bufferInfos.itemSize,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this._attributes.vertexPosition.location),this._material.bufferInfos={id:t.createBuffer(),itemSize:3,numberOfItems:this._material.uvs.length/3},t.bindBuffer(t.ARRAY_BUFFER,this._material.bufferInfos.id),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this._material.uvs),t.STATIC_DRAW),t.vertexAttribPointer(this._attributes.textureCoord.location,this._material.bufferInfos.itemSize,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this._attributes.textureCoord.location),this._canDraw=!0)},Curtains.Plane.prototype._setAttributes=function(){var e={vertexPosition:"aVertexPosition",textureCoord:"aTextureCoord"};this._attributes||(this._attributes={});var t=this;Object.keys(e).map(function(o){var r=e[o];t._attributes[o]={name:r,location:t._wrapper.glContext.getAttribLocation(t._program,r)}})},Curtains.Plane.prototype._handleUniformSetting=function(e,t,o){var r=this._wrapper.glContext;"1i"===e?r.uniform1i(t,o):"1iv"===e?r.uniform1iv(t,o):"1f"===e?r.uniform1f(t,o):"1fv"===e?r.uniform1fv(t,o):"2i"===e?r.uniform2i(t,o[0],o[1]):"2iv"===e?r.uniform2iv(t,o):"2f"===e?r.uniform2f(t,o[0],o[1]):"2fv"===e?r.uniform2fv(t,o):"3i"===e?r.uniform3i(t,o[0],o[1],o[2]):"3iv"===e?r.uniform3iv(t,o):"3f"===e?r.uniform3f(t,o[0],o[1],o[2]):"3fv"===e?r.uniform3fv(t,o):"4i"===e?r.uniform4i(t,o[0],o[1],o[2],o[3]):"4iv"===e?r.uniform4iv(t,o):"4f"===e?r.uniform4f(t,o[0],o[1],o[2],o[3]):"4fv"===e?r.uniform4fv(t,o):"mat2"===e?r.uniformMatrix2fv(t,!1,o):"mat3"===e?r.uniformMatrix3fv(t,!1,o):"mat4"===e?r.uniformMatrix4fv(t,!1,o):this._wrapper.productionMode||console.warn("This uniform type is not handled : ",e)},Curtains.Plane.prototype._setUniforms=function(e){var t=this._wrapper;t.glContext.useProgram(this._program);var o=this;e&&Object.keys(e).map(function(r){var a=e[r];o.uniforms[r].location=t.glContext.getUniformLocation(o._program,a.name),a.type||(Array.isArray(a.value)?4===a.value.length?(a.type="4f",!t.productionMode&&console.warn("No uniform type declared for "+a.name+", applied a 4f (array of 4 floats) uniform type")):3===a.value.length?(a.type="3f",!t.productionMode&&console.warn("No uniform type declared for "+a.name+", applied a 3f (array of 3 floats) uniform type")):2===a.value.length&&(a.type="2f",!t.productionMode&&console.warn("No uniform type declared for "+a.name+", applied a 2f (array of 2 floats) uniform type")):a.value.constructor===Float32Array?16===a.value.length?(a.type="mat4",!t.productionMode&&console.warn("No uniform type declared for "+a.name+", applied a mat4 (4x4 matrix array) uniform type")):9===a.value.length?(a.type="mat3",!t.productionMode&&console.warn("No uniform type declared for "+a.name+", applied a mat3 (3x3 matrix array) uniform type")):4===a.value.length&&(a.type="mat2",!t.productionMode&&console.warn("No uniform type declared for "+a.name+", applied a mat2 (2x2 matrix array) uniform type")):(a.type="1f",!t.productionMode&&console.warn("No uniform type declared for "+a.name+", applied a 1f (float) uniform type"))),o._handleUniformSetting(a.type,o.uniforms[r].location,a.value)})},Curtains.Plane.prototype._updateUniforms=function(){if(this.uniforms){var e=this;Object.keys(e.uniforms).map(function(t){var o=e.uniforms[t],r=o.location,a=o.value,n=o.type;e._handleUniformSetting(n,r,a)})}},Curtains.Plane.prototype._multiplyMatrix=function(e,t){var o=[],r=e[0],a=e[1],n=e[2],i=e[3],l=e[4],d=e[5],s=e[6],p=e[7],u=e[8],_=e[9],c=e[10],m=e[11],g=e[12],h=e[13],x=e[14],f=e[15],y=t[0],v=t[1],b=t[2],C=t[3];return o[0]=y*r+v*l+b*u+C*g,o[1]=y*a+v*d+b*_+C*h,o[2]=y*n+v*s+b*c+C*x,o[3]=y*i+v*p+b*m+C*f,y=t[4],v=t[5],b=t[6],C=t[7],o[4]=y*r+v*l+b*u+C*g,o[5]=y*a+v*d+b*_+C*h,o[6]=y*n+v*s+b*c+C*x,o[7]=y*i+v*p+b*m+C*f,y=t[8],v=t[9],b=t[10],C=t[11],o[8]=y*r+v*l+b*u+C*g,o[9]=y*a+v*d+b*_+C*h,o[10]=y*n+v*s+b*c+C*x,o[11]=y*i+v*p+b*m+C*f,y=t[12],v=t[13],b=t[14],C=t[15],o[12]=y*r+v*l+b*u+C*g,o[13]=y*a+v*d+b*_+C*h,o[14]=y*n+v*s+b*c+C*x,o[15]=y*i+v*p+b*m+C*f,o},Curtains.Plane.prototype._scaleMatrix=function(e,t,o,r){var a=new Float32Array(16);return a[0]=t*e[0],a[1]=t*e[1],a[2]=t*e[2],a[3]=t*e[3],a[4]=o*e[4],a[5]=o*e[5],a[6]=o*e[6],a[7]=o*e[7],a[8]=r*e[8],a[9]=r*e[9],a[10]=r*e[10],a[11]=r*e[11],e!==a&&(a[12]=e[12],a[13]=e[13],a[14]=e[14],a[15]=e[15]),a},Curtains.Plane.prototype._setPerspectiveMatrix=function(e,t,o){var r=this._wrapper._boundingRect.width/this._wrapper._boundingRect.height;e!==this._fov&&(this._fov=e);return[e/r,0,0,0,0,e,0,0,0,0,(t+o)*(1/(t-o)),-1,0,0,2*(t*o*(1/(t-o))),0]},Curtains.Plane.prototype.setPerspective=function(e,t,o){var r=parseInt(e)||75;0>r?r=0:180<r&&(r=180);var a=parseFloat(t)||.1,n=parseFloat(o)||100;this._matrices&&(this._matrices.pMatrix.matrix=this._setPerspectiveMatrix(r,a,n),this._wrapper.glContext.useProgram(this._program),this._wrapper.glContext.uniformMatrix4fv(this._matrices.pMatrix.location,!1,this._matrices.pMatrix.matrix),this._setMVMatrix())},Curtains.Plane.prototype._setMVMatrix=function(){var e=this._wrapper,t=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),o=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,this._translation.x,this._translation.y,this._translation.z-this._fov/2,1]),r=new Float32Array([1,0,0,0,0,Math.cos(this.rotation.x),Math.sin(this.rotation.x),0,0,-Math.sin(this.rotation.x),Math.cos(this.rotation.x),0,0,0,0,1]),a=new Float32Array([Math.cos(this.rotation.y),0,-Math.sin(this.rotation.y),0,0,1,0,0,Math.sin(this.rotation.y),0,Math.cos(this.rotation.y),0,0,0,0,1]),n=new Float32Array([Math.cos(this.rotation.z),Math.sin(this.rotation.z),0,0,-Math.sin(this.rotation.z),Math.cos(this.rotation.z),0,0,0,0,1,0,0,0,0,1]),i={x:this.scale.x*(e._boundingRect.width/e._boundingRect.height*this._boundingRect.computed.width/2),y:this.scale.y*this._boundingRect.computed.height/2},l=new Float32Array([i.x,0,0,0,0,i.y,0,0,0,0,1,0,0,0,0,1]),d=this._multiplyMatrix(t,o);d=this._multiplyMatrix(d,r),d=this._multiplyMatrix(d,a),d=this._multiplyMatrix(d,n),d=this._multiplyMatrix(d,l),this._matrices&&(this._matrices.mvMatrix.matrix=d,e.glContext.useProgram(this._program),e.glContext.uniformMatrix4fv(this._matrices.mvMatrix.location,!1,this._matrices.mvMatrix.matrix))},Curtains.Plane.prototype.setScale=function(e,t){e=parseFloat(e)||1,e=Math.max(e,.001),t=parseFloat(t)||1,t=Math.max(t,.001),this.scale={x:e,y:t},this.alwaysDraw||this._shouldDrawCheck(),this._setMVMatrix();for(var o=0;o<this.textures.length;o++)this.textures[o]._adjustTextureSize()},Curtains.Plane.prototype.setRotation=function(e,t,o){e=parseFloat(e)||0,t=parseFloat(t)||0,o=parseFloat(o)||0,this.rotation={x:e,y:t,z:o},this._setMVMatrix()},Curtains.Plane.prototype._setTranslation=function(){var e={x:0,y:0};(0!==this.relativeTranslation.x||0!==this.relativeTranslation.y)&&(e=this._documentToPlaneSpace(this.relativeTranslation.x,this.relativeTranslation.y)),this._translation.x=this._boundingRect.computed.left+e.x,this._translation.y=this._boundingRect.computed.top+e.y,this.alwaysDraw||this._shouldDrawCheck(),this._setMVMatrix()},Curtains.Plane.prototype.setRelativePosition=function(e,t){this.relativeTranslation={x:e,y:t},this._setTranslation()},Curtains.Plane.prototype._documentToPlaneSpace=function(e,t){var o=this._wrapper,r={x:e/(o._boundingRect.width/o.pixelRatio)*(o._boundingRect.width/o._boundingRect.height),y:-t/(o._boundingRect.height/o.pixelRatio)};return r},Curtains.Plane.prototype.mouseToPlaneCoords=function(e,t){var o={x:(this._boundingRect.document.width-this._boundingRect.document.width*this.scale.x)/2,y:(this._boundingRect.document.height-this._boundingRect.document.height*this.scale.y)/2},r={width:this._boundingRect.document.width*this.scale.x/this._wrapper.pixelRatio,height:this._boundingRect.document.height*this.scale.y/this._wrapper.pixelRatio,top:(this._boundingRect.document.top+o.y)/this._wrapper.pixelRatio,left:(this._boundingRect.document.left+o.x)/this._wrapper.pixelRatio},a={x:2*((e-r.left)/r.width)-1,y:1-2*((t-r.top)/r.height)};return a},Curtains.Plane.prototype._shouldDrawCheck=function(){var e={x:(this._boundingRect.document.width-this._boundingRect.document.width*this.scale.x)/2,y:(this._boundingRect.document.height-this._boundingRect.document.height*this.scale.y)/2},t={top:this._boundingRect.document.top+this.relativeTranslation.y+e.y,right:this._boundingRect.document.left+this.relativeTranslation.x+this._boundingRect.document.width-e.x,bottom:this._boundingRect.document.top+this.relativeTranslation.y+this._boundingRect.document.height-e.y,left:this._boundingRect.document.left+this.relativeTranslation.x+e.x},o=this;t.right<-0||t.left>this._wrapper._boundingRect.width+0||t.bottom<-0||t.top>this._wrapper._boundingRect.height+0?this._shouldDraw&&(this._shouldDraw=!1,setTimeout(function(){o._onLeaveViewCallback&&o._onLeaveViewCallback()},0)):(!this._shouldDraw&&setTimeout(function(){o._onReEnterViewCallback&&o._onReEnterViewCallback()},0),this._shouldDraw=!0)},Curtains.Plane.prototype._applyCSSPositions=function(){this._setComputedSizes(),this._setTranslation()},Curtains.Plane.prototype.updatePosition=function(){this._setDocumentSizes(),this._applyCSSPositions()},Curtains.Plane.prototype.enableDepthTest=function(e){this._shouldUseDepthTest=e},Curtains.Plane.prototype.moveToFront=function(){this.enableDepthTest(!1);for(var e=this._wrapper._drawStack,t=0;t<e.length;t++)this.index===e[t]&&e.splice(t,1);e.push(this.index)},Curtains.Plane.prototype.planeResize=function(){this.setPerspective(this._fov,.1,2*this._fov),this._setDocumentSizes(),this._setComputedSizes(),this._applyCSSPositions();for(var e=0;e<this.textures.length;e++)this.textures[e]._adjustTextureSize()},Curtains.Plane.prototype.createTexture=function(e){var o=new Curtains.Texture(this,{index:this.textures.length,sampler:e});return o},Curtains.Plane.prototype.loadSources=function(e){for(var t=0;t<e.length;t++)this.loadSource(e[t])},Curtains.Plane.prototype.loadSource=function(e){"IMG"===e.tagName.toUpperCase()?this.loadImage(e):"VIDEO"===e.tagName.toUpperCase()?this.loadVideo(e):"CANVAS"===e.tagName.toUpperCase()?this.loadCanvas(e):!this._wrapper.productionMode&&console.warn("this HTML tag could not be converted into a texture:",e.tagName)},Curtains.Plane.prototype.loadImage=function(e){var t=e;t.crossOrigin=this.crossOrigin||"anonymous",t.sampler=e.getAttribute("data-sampler")||null;var o=this.createTexture(t.sampler);o._onSourceLoadedHandler=o._onSourceLoaded.bind(o,t),t.addEventListener("load",o._onSourceLoadedHandler,!1),t.complete&&o._onSourceLoaded(t),this.images.push(t)},Curtains.Plane.prototype.loadVideo=function(e){var t=e;t.preload=!0,t.muted=!0,t.loop=!0,t.sampler=e.getAttribute("data-sampler")||null,t.crossOrigin=this.crossOrigin||"anonymous";var o=this.createTexture(t.sampler);o._onSourceLoadedHandler=o._onVideoLoadedData.bind(o,t),t.addEventListener("canplaythrough",o._onSourceLoadedHandler,!1),t.readyState>=t.HAVE_FUTURE_DATA&&o._onSourceLoaded(t),t.load(),this.videos.push(t)},Curtains.Plane.prototype.loadCanvas=function(e){var t=e;t.sampler=e.getAttribute("data-sampler")||null;var o=this.createTexture(t.sampler);this.canvases.push(t),o._onSourceLoaded(t)},Curtains.Plane.prototype.loadImages=function(e){for(var t=0;t<e.length;t++)this.loadImage(e[t])},Curtains.Plane.prototype.loadVideos=function(e){for(var t=0;t<e.length;t++)this.loadVideo(e[t])},Curtains.Plane.prototype.loadCanvases=function(e){for(var t=0;t<e.length;t++)this.loadCanvas(e[t])},Curtains.Plane.prototype.playVideos=function(){for(var e,t=0;t<this.textures.length;t++)if(e=this.textures[t],"video"===e.type){var o=e.source.play(),r=this;void 0!==o&&o.catch(function(e){r._wrapper.productionMode||console.warn("Could not play the video : ",e)})}},Curtains.Plane.prototype._bindPlaneBuffers=function(){var e=this._wrapper.glContext;e.bindBuffer(e.ARRAY_BUFFER,this._geometry.bufferInfos.id),e.vertexAttribPointer(this._attributes.vertexPosition.location,this._geometry.bufferInfos.itemSize,e.FLOAT,!1,0,0),e.enableVertexAttribArray(this._attributes.vertexPosition.location),e.bindBuffer(e.ARRAY_BUFFER,this._material.bufferInfos.id),e.vertexAttribPointer(this._attributes.textureCoord.location,this._material.bufferInfos.itemSize,e.FLOAT,!1,0,0),e.enableVertexAttribArray(this._attributes.textureCoord.location)},Curtains.Plane.prototype._bindPlaneTexture=function(e){var t=this._wrapper.glContext;t.activeTexture(t.TEXTURE0+e.index),t.bindTexture(t.TEXTURE_2D,e._sampler.texture)},Curtains.Plane.prototype._drawPlane=function(){var e=this._wrapper.glContext;if(this._canDraw&&(e.useProgram(this._program),this._onRenderCallback&&this._onRenderCallback(),this._updateUniforms(),this._shouldDraw)){for(var t=0;t<this.textures.length;t++)this.textures[t]._drawTexture();this._bindPlaneBuffers(),e.drawArrays(e.TRIANGLES,0,this._geometry.bufferInfos.numberOfItems)}},Curtains.Plane.prototype._dispose=function(){for(var e=this._wrapper.glContext,t=0;t<this.textures.length;t++)this.textures[t]._dispose();this.textures=null,e&&(this._geometry&&(e.bindBuffer(e.ARRAY_BUFFER,this._geometry.bufferInfos.id),e.bufferData(e.ARRAY_BUFFER,1,e.STATIC_DRAW),e.deleteBuffer(this._geometry.bufferInfos.id),this._geometry=null),this._material&&(e.bindBuffer(e.ARRAY_BUFFER,this._material.bufferInfos.id),e.bufferData(e.ARRAY_BUFFER,1,e.STATIC_DRAW),e.deleteBuffer(this._material.bufferInfos.id),this._material=null),this._shaders&&(e.deleteShader(this._shaders.fragmentShader),e.deleteShader(this._shaders.vertexShader),this._shaders=null),this._program&&(e.deleteProgram(this._program),this._program=null))},Curtains.Plane.prototype.onLoading=function(e){return e&&(this._onPlaneLoadingCallback=e),this},Curtains.Plane.prototype.onReady=function(e){return e&&(this._onReadyCallback=e),this},Curtains.Plane.prototype.onReEnterView=function(e){return e&&(this._onReEnterViewCallback=e),this},Curtains.Plane.prototype.onLeaveView=function(e){return e&&(this._onLeaveViewCallback=e),this},Curtains.Plane.prototype.onRender=function(e){return e&&(this._onRenderCallback=e),this},Curtains.Texture=function(e,t){return this._plane=e,this._wrapper=e._wrapper,this._sampler={name:t.sampler||null},this._willUpdate=!1,this.shouldUpdate=!1,this.scale={x:1,y:1},this._init(),e.textures.push(this),this},Curtains.Texture.prototype._init=function(){var e=this._wrapper.glContext,t=this._plane;this._sampler.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this._sampler.texture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([0,0,0,255])),this.index=t.textures.length,this._sourceLoaded=!1,e.useProgram(t._program);var o=this._sampler.name||"uSampler"+this.index;this._sampler.location=e.getUniformLocation(t._program,o),e.uniform1i(this._sampler.location,this.index);var r=this._sampler.name?this._sampler.name+"Matrix":"uTextureMatrix"+this.index;this._textureMatrix={name:r,matrix:null,location:e.getUniformLocation(this._plane._program,r)}},Curtains.Texture.prototype.setSource=function(e){this.source=e,"IMG"===e.tagName.toUpperCase()?this.type="image":"VIDEO"===e.tagName.toUpperCase()?(this.type="video",this.shouldUpdate=!0):"CANVAS"===e.tagName.toUpperCase()?(this.type="canvas",this._willUpdate=!0,this.shouldUpdate=!0):!this._wrapper.productionMode&&console.warn("this HTML tag could not be converted into a texture:",e.tagName),this._size={width:this.source.width||this.source.videoWidth,height:this.source.height||this.source.videoHeight};var t=this._wrapper.glContext;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.bindTexture(t.TEXTURE_2D,this._sampler.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),this._adjustTextureSize(),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e)},Curtains.Texture.prototype._update=function(){var e=this._wrapper.glContext;e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.source)},Curtains.Texture.prototype._getSizes=function(){var e=this._plane._boundingRect.document.width*this._plane.scale.x,t=this._plane._boundingRect.document.height*this._plane.scale.y,o=this._size.width,r=this._size.height,a=o/r,n=e/t,i=0,l=0;n>a?l=Math.min(0,(t-e*(1/a))/2):n<a&&(i=Math.min(0,(e-t*a)/2));var d={planeWidth:e,planeHeight:t,sourceWidth:o,sourceHeight:r,xOffset:i,yOffset:l};return d},Curtains.Texture.prototype.setScale=function(e,t){e=parseFloat(e)||1,e=Math.max(e,.001),t=parseFloat(t)||1,t=Math.max(t,.001),this.scale={x:e,y:t},this._adjustTextureSize()},Curtains.Texture.prototype._adjustTextureSize=function(){if(this.source){var e=this._getSizes();this._updateTextureMatrix(e)}},Curtains.Texture.prototype._updateTextureMatrix=function(e){var t={x:e.planeWidth/(e.planeWidth-2*e.xOffset),y:e.planeHeight/(e.planeHeight-2*e.yOffset),x:this.scale.x,y:this.scale.y},o=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,(1-t.x)/2,(1-t.y)/2,0,1]);this._textureMatrix.matrix=this._plane._scaleMatrix(o,t.x,t.y,1),this._wrapper.glContext.useProgram(this._plane._program),this._wrapper.glContext.uniformMatrix4fv(this._textureMatrix.location,!1,this._textureMatrix.matrix)},Curtains.Texture.prototype._onSourceLoaded=function(e){this._plane._loadingManager.sourcesLoaded++,this.setSource(e);var t=this;this._sourceLoaded||setTimeout(function(){t._plane._onPlaneLoadingCallback&&t._plane._onPlaneLoadingCallback()},0),this._sourceLoaded=!0},Curtains.Texture.prototype._onVideoLoadedData=function(e){this._sourceLoaded||this._onSourceLoaded(e)},Curtains.Texture.prototype._drawTexture=function(){this._plane._bindPlaneTexture(this),"video"===this.type&&this.source&&this.source.readyState>=this.source.HAVE_CURRENT_DATA&&(this._willUpdate=!this._willUpdate),this._willUpdate&&this.shouldUpdate&&this._update()},Curtains.Texture.prototype._dispose=function(){"video"===this.type?(this.source.removeEventListener("canplaythrough",this._onSourceLoadedHandler,!1),this.source.pause(),this.source.removeAttribute("src"),this.source.load(),this.source.updateInterval&&clearInterval(this.source.updateInterval)):"canvas"===this.type?this.source.width=this.source.width:"image"===this.type&&this.source.removeEventListener("load",this._onSourceLoadedHandler,!1),this.source=null;var e=this._wrapper.glContext;e&&(e.activeTexture(e.TEXTURE0+this.index),e.bindTexture(e.TEXTURE_2D,null),e.deleteTexture(this._sampler.texture)),this._plane._loadingManager.sourcesLoaded--};